<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
video {
    width: 45%;
    margin: 10px;
    background: black;
}
body { background:#000; color:white; text-align:center; }
</style>
</head>
<body>

<video id="localVideo" autoplay playsinline muted></video>
<video id="remoteVideo" autoplay playsinline></video>

<script>

let pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then(stream => {
    document.getElementById("localVideo").srcObject = stream;
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
});

pc.ontrack = e => {
    document.getElementById("remoteVideo").srcObject = e.streams[0];
};

pc.onicecandidate = e => {
    if (e.candidate)
        chrome.webview.postMessage(
            "candidate:" +
            e.candidate.candidate + "|" +
            e.candidate.sdpMid + "|" +
            e.candidate.sdpMLineIndex
        );
};

async function createOffer() {
    let offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    chrome.webview.postMessage("offer:" + offer.sdp);
}

async function setRemoteOffer(sdp) {
    await pc.setRemoteDescription(
        new RTCSessionDescription({ type: "offer", sdp })
    );
}

async function createAnswer() {
    let answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    chrome.webview.postMessage("answer:" + answer.sdp);
}

async function toggleMute(mute) {
    pc.getSenders().forEach(s => {
        if (s.track && s.track.kind === "audio")
            s.track.enabled = !mute;
    });
}

</script>
</body>
</html>
